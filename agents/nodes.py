from core.llm_factory import get_llm
from core.models import ReflectionOutput, AgentState
from langchain_core.messages import HumanMessage
from langchain_core.messages import SystemMessage

llm = get_llm()

def strategist_node(state: AgentState):
    # Явное описание схемы для модели в промпте
    system_prompt = f"""
    ТЫ: Главный стратег технического интервью. 
    
    ОБЯЗАТЕЛЬНЫЕ ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ:
    1. Ответ должен быть СТРОГО в формате JSON.
    2. Поле 'intent' должно принимать только одно из значений: 'greeting', 'answer', 'question', 'nonsense', 'command', 'i_dont_know'. (НЕ ПЕРЕВОДИ ИХ НА РУССКИЙ).
    3. Поля 'is_correct' (boolean) и 'analysis' (string) ОБЯЗАТЕЛЬНЫ.
    
    СТРУКТУРА ОТВЕТА (JSON):
    {{
      "intent": "string",
      "is_correct": boolean,
      "analysis": "разбор на русском",
      "strategy": "план на русском",
      "instruction": "команда рекрутеру",
      "stop_interview": boolean
    }}

    ПРИМЕР:
    {{
      "intent": "greeting",
      "is_correct": true,
      "analysis": "Кандидат поздоровался и назвал стек.",
      "strategy": "Начинаем с основ Python.",
      "instruction": "Поприветствуй Алекса и спроси про декораторы.",
      "stop_interview": false
    }}

    ТВОЯ ЗАДАЧА:
    1. КЛАССИФИКАЦИЯ: Определи intent (Приветствие, Ответ, Вопрос, Бред, Команда).
    2. ПЕРЕХОД: Сразу после приветствия ТЫ ДОЛЖЕН выбрать навык из названных кандидатом и передать интервьюеру технический вопрос.
    3. ХОД 3 (HALLUCINATION TEST): Если кандидат говорит чушь (про Python 4.0, замену циклов на нейросети), пометь intent как NONSENSE. 
       Инструкция: Вежливо, но твердо опровергни этот миф. Не соглашайся!
    4. ХОД 4 (ROLE REVERSAL): Если кандидат задает вопросы о компании/стеке, пометь intent как QUESTION.
       Инструкция: Кратко ответь на вопрос, а затем вернись к интервью.
    5. Если кандидат говорит "не знаю", "не уверен" или дает в корне неверный ответ:
       - Пометь intent как IDK.
       - В 'instruction' СФОРМУЛИРУЙ краткий и правильный технический ответ на твой же вопрос.
       - Прикажи Рекрутеру озвучить этот ответ и СРАЗУ сменить тему на другую. ПРАВИЛО: Не задавай один и тот же вопрос дважды. Если ответа нет — закрываем тему.
    6. ХОД 5 (FEEDBACK): Если просят "стоп" или "фидбэк", пометь intent как COMMAND и заверши интервью.
    
    ВНУТРЕННИЙ ДИАЛОГ - СТРОГО НА РУССКОМ.
    """
    
    # Оставляем json_mode для стабильности на OpenRouter
    structured_llm = llm.with_structured_output(ReflectionOutput, method="json_mode")
    
    msgs = [SystemMessage(content=system_prompt)] + state["messages"]
    if not state["messages"]:
        msgs.append(HumanMessage(content="Начинаем интервью."))
        
    try:
        res = structured_llm.invoke(msgs)
    except Exception as e:
        # Логируем ошибку, но даем дефолтный ответ, чтобы цикл не прерывался
        print(f"\n[DEBUG] Ошибка парсинга JSON: {e}")
        return {
            "internal_thoughts": "Ошибка структуры ответа. Используется аварийный режим.",
            "next_instruction": "Поприветствуй кандидата и попроси рассказать о себе.",
            "is_finished": False
        }
    
    
    return {
        "internal_thoughts": f"[Intent: {res.intent.value}] | {res.analysis}",
        "next_instruction": res.instruction,
        "is_finished": res.stop_interview
    }




def interviewer_node(state: AgentState):

    is_first_message = len(state["messages"]) == 0
    
    
    prompt = f"""
    ТЫ: Профессиональный IT-рекрутер.
    ТВОЯ ЗАДАЧА: Вести техническое интервью, опираясь на указания Стратега.

    {"ЭТО НАЧАЛО ИНТЕРВЬЮ. Поприветствуй кандидата и расскажи, что он на техническом собеседовании. Попроси его представиться, тебе необходимо получить информацию о его позиции и навыках" if is_first_message else "Продолжай диалог согласно инструкции."}
    
    ИНСТРУКЦИЯ ОТ СТРАТЕГА(не говори это кандидату): {state['next_instruction']}
    
    ПРАВИЛА ОБЩЕНИЯ:
    1. Пиши ТОЛЬКО текст, предназначенный для кандидата.
    2. НИКОГДА не упоминай "Стратега", "Критика", "Инструкции" или "Баллы".
    3. Говори естественно, как человек. Используй только в подходящих случаях фразы: "Принято", "Хорошо, тогда пойдем дальше", "Интересно, а расскажи подробнее про...".
    4. Если Стратег говорит, что ответ неверный — не соглашайся с кандидатом. Вежливо поправь его или задай уточняющий вопрос, чтобы он сам нашел ошибку.
    5. Если инструкция требует задать вопрос — задавай его прямо.
    6. После получения ответа от кандидата — не подводи итоги и не делай выводы. Просто продолжай интервью с новым вопросом.
    7. Неспрашивай то, что ранее уже сказал ты сам или кандидат.
    8. Твоя цель получать ответы на вопросы, которые помогут оценить технические навыки кандидата.
    9. Если ты считаешь, что интервью можно завершить — аккуратно попрощайся с кандидатом и скажи, что свяжетесь с ним позже. А также если кандидат попросил завершить интервью.
    """
    
    # Мы передаем историю сообщений, чтобы Интервьюер видел, на чем остановился диалог
    response = llm.invoke([
        ("system", prompt),
        *state["messages"]
    ])
    
    return {"messages": [response]}